<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"      
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    
    <head th:replace="~{general/fragmentos :: head}"/>
    
    <body>
        <header th:replace="~{general/fragmentos :: header}"/>
        
        <div class="container mt-5">
            
            <section th:replace="~{general/fragmentos :: mostrarToast}"></section>

            <h1 class="display-4 text-center mb-4">[[#{index.bienvenida}]]</h1>
            <h3 class="text-center text-muted mb-5">[[#{index.nuestrosServicios}]]</h3>
            
            <h2 class="mt-5 mb-3 text-info">
                <i class="fa-solid fa-user-doctor"></i> [[#{menu.doctores}]]
            </h2>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <div class="col" th:each="doctor : ${doctores}">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title" th:text="${'Dr(a). ' + doctor.nombre}"></h5>
                            <p class="card-text text-muted" th:text="${doctor.especialidad}"></p>
                            <p class="card-text flex-grow-1">Disponibilidad restante: <span th:text="${doctor.disponibilidad}">0</span> citas</p>

                            <span class="fs-4 fw-bold text-success">
                                [[${'₡' + #numbers.formatDecimal(doctor.tarifa, 0, 'COMMA', 2, 'POINT')}]]
                            </span>
                            
                            <button type="button" 
                                    class="btn btn-sm btn-primary mt-2" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#reservaModal"
                                    th:data-doctor-id="${doctor.idDoctor}"
                                    th:data-doctor-nombre="${doctor.nombre}"
                                    th:data-doctor-tarifa="${doctor.tarifa}"
                                    sec:authorize="isAuthenticated()">
                                <i class="fa-solid fa-calendar-check"></i> Reservar Cita
                            </button>
                            <a th:href="@{/login}" class="btn btn-sm btn-primary mt-2" sec:authorize="!isAuthenticated()">
                                Iniciar Sesión para Reservar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-info">
                <i class="fa-solid fa-book-open"></i> [[#{menu.librosAutoayuda}]]
            </h2>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                 <div class="col" th:each="libro : ${libros}">
                    <div class="card h-100 shadow-sm">
                        <img th:src="@{${libro.rutaImagen}}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="Imagen Libro"/>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title" th:text="${libro.titulo}"></h5>
                            <p class="card-text flex-grow-1" th:text="${libro.autor}"></p>
                            <span class="fs-4 fw-bold text-success" th:text="${'₡' + #numbers.formatDecimal(libro.precio, 0, 'COMMA', 2, 'POINT')}">₡ 0.00</span>
                            
                            <form th:action="@{/carrito/agregar}" method="post">
                                <input type="hidden" name="idEntidad" th:value="${libro.idLibro}">
                                <input type="hidden" name="tipoItem" value="LIBRO">
                                <input type="hidden" name="cantidad" value="1">
                                <button type="submit" class="btn btn-sm btn-dark mt-2" sec:authorize="isAuthenticated()">
                                    <i class="fa-solid fa-cart-plus"></i> [[#{accion.agregar}]] al Carrito
                                </button>
                                <a th:href="@{/login}" class="btn btn-sm btn-dark mt-2" sec:authorize="!isAuthenticated()">
                                    Iniciar Sesión para Comprar
                                </a>
                            </form>
                            </div>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-success">
                <i class="fa-solid fa-apple-whole"></i> [[#{menu.alimentacion}]]
            </h2>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                 <div class="col" th:each="alimento : ${alimentos}">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title" th:text="${alimento.nombre}"></h5>
                            <p class="card-text flex-grow-1" th:text="${alimento.tipo} + ' - ' + ${alimento.calorias} + ' Cal'">Tipo / Calorías</p>
                            <span class="fs-4 fw-bold text-success" th:text="${'₡' + #numbers.formatDecimal(alimento.precio, 0, 'COMMA', 2, 'POINT')}">₡ 0.00</span>
                            
                            <form th:action="@{/carrito/agregar}" method="post">
                                <input type="hidden" name="idEntidad" th:value="${alimento.id}">
                                <input type="hidden" name="tipoItem" value="ALIMENTO">
                                <input type="hidden" name="cantidad" value="1">
                                <button type="submit" class="btn btn-sm btn-dark mt-2" sec:authorize="isAuthenticated()">
                                    <i class="fa-solid fa-cart-plus"></i> [[#{accion.agregar}]] al Carrito
                                </button>
                                <a th:href="@{/login}" class="btn btn-sm btn-dark mt-2" sec:authorize="!isAuthenticated()">
                                    Iniciar Sesión para Comprar
                                </a>
                            </form>
                            </div>
                    </div>
                </div>
            </div>
            
            <h2 class="mt-5 mb-3 text-danger">
                <i class="fa-solid fa-heart-pulse"></i> [[#{menu.ejerciciosCardio}]]
            </h2>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                 <div class="col" th:each="ejercicio : ${ejercicios}">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title" th:text="${ejercicio.nombre}"></h5>
                            <p class="card-text flex-grow-1" th:text="${ejercicio.duracionMinutos} + ' Minutos'">Duración</p>
                            <span class="fs-4 fw-bold text-success" th:text="${'₡' + #numbers.formatDecimal(ejercicio.precio, 0, 'COMMA', 2, 'POINT')}">₡ 0.00</span>
                            
                            <form th:action="@{/carrito/agregar}" method="post">
                                <input type="hidden" name="idEntidad" th:value="${ejercicio.id}">
                                <input type="hidden" name="tipoItem" value="EJERCICIO">
                                <input type="hidden" name="cantidad" value="1">
                                <button type="submit" class="btn btn-sm btn-dark mt-2" sec:authorize="isAuthenticated()">
                                    <i class="fa-solid fa-cart-plus"></i> [[#{accion.agregar}]] al Carrito
                                </button>
                                <a th:href="@{/login}" class="btn btn-sm btn-dark mt-2" sec:authorize="!isAuthenticated()">
                                    Iniciar Sesión para Comprar
                                </a>
                            </form>
                            </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form th:action="@{/carrito/agregar}" method="post">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="reservaModalLabel">Reservar Cita con <span id="modalDoctorNombre"></span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="tipoItem" value="DOCTOR">
                            <input type="hidden" name="idEntidad" id="modalDoctorId">
                            <input type="hidden" name="cantidad" value="1"> 
                            
                            <p class="mb-3">Tarifa de Consulta: <strong id="modalDoctorTarifa"></strong></p>
                            
                            <div class="mb-3">
                                <label for="fechaCita" class="form-label">Selecciona la Fecha:</label>
                                <input type="date" 
                                        class="form-control" 
                                        id="fechaCita" 
                                        name="fechaCita" 
                                        required 
                                        th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="horaCita" class="form-label">Selecciona la Hora:</label>
                                <input type="time"
                                       class="form-control"
                                       id="horaCita"
                                       name="horaCita"
                                       required>
                            </div>
                            
                            <div class="alert alert-info small mt-3">
                                <i class="fa-solid fa-clock"></i> Horario de 8:00 a 16:00, sujeto a disponibilidad del doctor.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[[#{accion.cancelar}]]</button>
                            <button type="submit" class="btn btn-success">
                                <i class="fa-solid fa-cart-plus"></i> Agregar al Carrito
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var reservaModal = document.getElementById('reservaModal');
                reservaModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var doctorId = button.getAttribute('data-doctor-id');
                    var doctorNombre = button.getAttribute('data-doctor-nombre');
                    var doctorTarifa = button.getAttribute('data-doctor-tarifa');

                    var modalDoctorId = reservaModal.querySelector('#modalDoctorId');
                    var modalDoctorNombre = reservaModal.querySelector('#modalDoctorNombre');
                    var modalDoctorTarifa = reservaModal.querySelector('#modalDoctorTarifa');
                    
                    modalDoctorId.value = doctorId;
                    modalDoctorNombre.textContent = doctorNombre;
                    
                    modalDoctorTarifa.textContent = '₡' + parseFloat(doctorTarifa).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    
                    var horaCita = reservaModal.querySelector('#horaCita');
                    if (!horaCita.value) {
                         horaCita.value = '08:00'; 
                    }
                });
            });
        </script>
        
        <footer th:replace="~{general/fragmentos :: footer}"/>
    </body>
</html>